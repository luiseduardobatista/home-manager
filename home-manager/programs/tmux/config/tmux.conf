# ==========================================
# GERAL E PREFIXO
# ==========================================
unbind C-b
set -g prefix C-f
set -g mouse on
set -s escape-time 0         # Remove delay do Vim
set -g history-limit 50000
set -g display-time 4000
set -g base-index 1          # Janelas come√ßam em 1
set -g pane-base-index 1     # Pain√©is come√ßam em 1
set -g renumber-windows on   # Renumera ao fechar janelas
set -g detach-on-destroy off # N√£o sai do tmux ao fechar √∫ltima sess√£o
set -g focus-events on       # Importante para nvim
set -g default-terminal "tmux-256color"
set-option -sa terminal-overrides ",xterm*:Tc"

bind R source-file "$HOME/.config/tmux/tmux.conf" \; display "Configura√ß√£o Recarregada!"

# ==========================================
# MODO NORMAL
# ==========================================

# Menus (Sub-modos)
bind-key p switch-client -T pane
bind-key r switch-client -T resize
bind-key t switch-client -T tab
bind-key m switch-client -T move
bind-key s switch-client -T scroll
bind-key o switch-client -T session

# A√ß√µes R√°pidas
bind-key / copy-mode \; send-keys ?  # Busca r√°pida
bind-key 1 select-window -t 1
bind-key 2 select-window -t 2
bind-key 3 select-window -t 3
bind-key 4 select-window -t 4
bind-key 5 select-window -t 5

# ==========================================
# MODO PANE (Menu 'p')
# ==========================================
bind-key -T pane f resize-pane -Z \; switch-client -T root          # Fullscreen
bind-key -T pane d split-window -v \; switch-client -T root         # Down
bind-key -T pane r split-window -h \; switch-client -T root         # Right
bind-key -T pane x kill-pane \; switch-client -T root               # Close
bind-key -T pane c command-prompt -I "#T" "select-pane -T '%%'" \; switch-client -T pane # Rename

# Navega√ß√£o (Mant√©m no modo Pane para movimentos r√°pidos)
bind-key -T pane h select-pane -L \; switch-client -T pane
bind-key -T pane j select-pane -D \; switch-client -T pane
bind-key -T pane k select-pane -U \; switch-client -T pane
bind-key -T pane l select-pane -R \; switch-client -T pane

# Sair
bind-key -T pane Escape switch-client -T root
bind-key -T pane Enter switch-client -T root

# ==========================================
# MODO TAB (Menu 't')
# ==========================================
bind-key -T tab n new-window \; switch-client -T root
bind-key -T tab r command-prompt -I "#W" "rename-window '%%'" \; switch-client -T tab
bind-key -T tab x kill-window \; switch-client -T root
bind-key -T tab h previous-window \; switch-client -T tab
bind-key -T tab l next-window \; switch-client -T tab
bind-key -T tab Left previous-window \; switch-client -T tab
bind-key -T tab Right next-window \; switch-client -T tab

bind-key -T tab Escape switch-client -T root
bind-key -T tab Enter switch-client -T root

# ==========================================
# MODO RESIZE (Menu 'r')
# ==========================================
bind-key -T resize h resize-pane -L 5 \; switch-client -T resize
bind-key -T resize j resize-pane -D 5 \; switch-client -T resize
bind-key -T resize k resize-pane -U 5 \; switch-client -T resize
bind-key -T resize l resize-pane -R 5 \; switch-client -T resize

# Atalhos compartilhados
bind-key -T resize p switch-client -T pane
bind-key -T resize s switch-client -T scroll
bind-key -T resize Escape switch-client -T root
bind-key -T resize Enter switch-client -T root

# ==========================================
# MODO MOVE (Menu 'm')
# ==========================================
bind-key -T move h swap-pane -s '{left-of}' \; switch-client -T move
bind-key -T move j swap-pane -s '{down-of}' \; switch-client -T move
bind-key -T move k swap-pane -s '{up-of}' \; switch-client -T move
bind-key -T move l swap-pane -s '{right-of}' \; switch-client -T move
bind-key -T move n next-layout \; switch-client -T move
bind-key -T move Escape switch-client -T root
bind-key -T move Enter switch-client -T root

# ==========================================
# MODO SCROLL / SEARCH (Menu 's')
# ==========================================
setw -g mode-keys vi

# 'f' entra no modo busca direto
bind-key -T scroll f copy-mode \; send-keys ?
# 'e' entra no modo visualiza√ß√£o/c√≥pia
bind-key -T scroll e copy-mode \; switch-client -T root
# 's' sai (cancela)
bind-key -T scroll s switch-client -T root
bind-key -T scroll Escape switch-client -T root

# Configura√ß√£o Vi Copy-Mode
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind-key -T copy-mode-vi Escape send-keys -X cancel

# ==========================================
# MODO SESSION (Menu 'o')
# ==========================================
bind-key -T session d detach-client
# bind-key -T session w choose-tree -Z
bind-key -T session w run-shell "sesh connect \"$(
  sesh list --icons | fzf-tmux -p 90%,90% \
    --no-sort --ansi --border-label ' sesh ' --prompt '‚ö°  ' \
    --header '  C-a All | C-t Tmux | C-x Zoxide | C-f Find | C-d Kill Session' \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-a:change-prompt(‚ö°  )+reload(sesh list --icons)' \
    --bind 'ctrl-t:change-prompt(ü™ü  )+reload(sesh list -t --icons)' \
    --bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -z --icons)' \
    --bind 'ctrl-f:change-prompt(üîé  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind 'ctrl-d:execute(tmux kill-session -t {2..})+change-prompt(‚ö°  )+reload(sesh list --icons)' \
    --preview-window 'right:50%' \
    --preview 'sesh preview {}'
)\""

bind-key -T session Escape switch-client -T root
bind-key -T session Enter switch-client -T root

# ==========================================
# SMART SPLITS (Navega√ß√£o Vim/Tmux)
# ==========================================
# Esta vers√£o funciona sem plugins extras, apenas verificando o processo.
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"

bind-key -n C-h if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n C-j if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n C-k if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n C-l if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'

# Redimensionamento com Alt (M) + hjkl
bind-key -n M-h if-shell "$is_vim" 'send-keys M-h' 'resize-pane -L 3'
bind-key -n M-j if-shell "$is_vim" 'send-keys M-j' 'resize-pane -D 3'
bind-key -n M-k if-shell "$is_vim" 'send-keys M-k' 'resize-pane -U 3'
bind-key -n M-l if-shell "$is_vim" 'send-keys M-l' 'resize-pane -R 3'

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R
bind-key -T copy-mode-vi 'C-\' select-pane -l

# ==========================================
# OUTROS
# ==========================================

source-file ~/.config/tmux/statusline.conf
